<!DOCTYPE html>
<html>

<head>
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="description" content="A new Hugo site.">
<title>
方便安全的缓存NSCache - Cb7d
</title>




<link rel="shortcut icon" href="https://min.felixplus.top/public/icon/man_icon_square.JPG?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ZYHZHANGYUNHAO931119%2F20200223%2F%2Fs3%2Faws4_request&amp;X-Amz-Date=20200223T024742Z&amp;X-Amz-Expires=432000&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=c5cfbe0ee2c297b46bcf68413178d4f0752d10171e51fe31713b02384b2617e3">








<link rel="stylesheet" href="http://example.org/css/main.min.81bbafc4df93b11c1c3e2449464373c384aa4903731b4fc7a77dfcdd979e184f.css" integrity="sha256-gbuvxN&#43;TsRwcPiRJRkNzw4SqSQNzG0/Hp3383ZeeGE8=" crossorigin="anonymous" media="screen">



 

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Didact+Gothic">

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://example.org/tn.png"/>

<meta name="twitter:title" content="方便安全的缓存NSCache"/>
<meta name="twitter:description" content="NSCache NSCache 基本上就是一个会自动移除对象来释放内存的 NSMutableDictionary。无需响应内存警告或者使用计时器来清除缓存。唯一的不同之处是键对象不会像 NSMutableDictionary 中那样被复制，这实际上是它的一个优点（键不需要实现 NSCopying 协议）。
先列一下使用NSCache的好处  NSCache是一个类似NSDictionary一个可变的集合。 提供了可设置缓存的数目与内存大小限制的方式。 保证了处理的数据的线程安全性。 缓存使用的key不需要是实现NSCopying。 当内存警告时内部自动清理部分缓存数据。  NSCache的属性与方法 @property (assign) id&lt;NSCacheDelegate&gt;delegate; cache对象的代理 ， 用来即将清理cache的时候得到通知
- (void)cache:(NSCache *)cache willEvictObject:(id)obj; 代理方法 ， 这里面不要对cache进行改动 ， 如果对象obj需要被持久化存储的话可以在这里进行操作
这里面有几种情况会导致该方法执行：
 手动移除（removeObjectForKey） 缓存超过设定的上线 App不活跃 系统内存爆炸  @property BOOL evictsObjectsWithDiscardedContent; 该属性默认为True ， 表示在内存销毁时丢弃该对象 。
@property NSUInteger totalCostLimit; 总成本数 ， 用来设置最大缓存数量
开始使用NSCache // // TDFSetPhoneNumController.m // TDFLoginModule // // Created by doubanjiang on 2017/6/5. // Copyright © 2017年 doubanjiang. All rights reserved."/>

<meta property="og:title" content="方便安全的缓存NSCache" />
<meta property="og:description" content="NSCache NSCache 基本上就是一个会自动移除对象来释放内存的 NSMutableDictionary。无需响应内存警告或者使用计时器来清除缓存。唯一的不同之处是键对象不会像 NSMutableDictionary 中那样被复制，这实际上是它的一个优点（键不需要实现 NSCopying 协议）。
先列一下使用NSCache的好处  NSCache是一个类似NSDictionary一个可变的集合。 提供了可设置缓存的数目与内存大小限制的方式。 保证了处理的数据的线程安全性。 缓存使用的key不需要是实现NSCopying。 当内存警告时内部自动清理部分缓存数据。  NSCache的属性与方法 @property (assign) id&lt;NSCacheDelegate&gt;delegate; cache对象的代理 ， 用来即将清理cache的时候得到通知
- (void)cache:(NSCache *)cache willEvictObject:(id)obj; 代理方法 ， 这里面不要对cache进行改动 ， 如果对象obj需要被持久化存储的话可以在这里进行操作
这里面有几种情况会导致该方法执行：
 手动移除（removeObjectForKey） 缓存超过设定的上线 App不活跃 系统内存爆炸  @property BOOL evictsObjectsWithDiscardedContent; 该属性默认为True ， 表示在内存销毁时丢弃该对象 。
@property NSUInteger totalCostLimit; 总成本数 ， 用来设置最大缓存数量
开始使用NSCache // // TDFSetPhoneNumController.m // TDFLoginModule // // Created by doubanjiang on 2017/6/5. // Copyright © 2017年 doubanjiang. All rights reserved." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/posts/nscache/" />
<meta property="og:image" content="http://example.org/tn.png"/>
<meta property="article:published_time" content="2020-02-19T10:46:42+08:00" />
<meta property="article:modified_time" content="2020-02-19T10:46:42+08:00" /><meta property="og:site_name" content="Cb7d" />


    

    
    
    
    <title>
        
        方便安全的缓存NSCache
        
    </title>
</head>

<body>
    <div class="wrap">
        <div class="section" id="title">方便安全的缓存NSCache</div>

        
<div class="section" id="content">
    Wed Feb 19, 2020 &#183; 249 words
    <div class="tag-container">
        
        
        <span class="tag">
            <a href="http://example.org/tags/blog/">
                blog
            </a>
        </span>
        
        
        
        <span class="tag">
            <a href="http://example.org/tags/ios/">
                iOS
            </a>
        </span>
        
        
        
        <span class="tag">
            <a href="http://example.org/tags/objc/">
                ObjC
            </a>
        </span>
        
        
    </div>
    <hr/>
    <h1 id="nscache">NSCache</h1>
<p>NSCache 基本上就是一个会自动移除对象来释放内存的 NSMutableDictionary。无需响应内存警告或者使用计时器来清除缓存。唯一的不同之处是键对象不会像 NSMutableDictionary 中那样被复制，这实际上是它的一个优点（键不需要实现 NSCopying 协议）。</p>
<h3 id="先列一下使用nscache的好处">先列一下使用NSCache的好处</h3>
<ul>
<li>NSCache是一个类似NSDictionary一个可变的集合。</li>
<li>提供了可设置缓存的数目与内存大小限制的方式。</li>
<li>保证了处理的数据的线程安全性。</li>
<li>缓存使用的key不需要是实现NSCopying。</li>
<li>当内存警告时内部自动清理部分缓存数据。</li>
</ul>
<h3 id="nscache的属性与方法">NSCache的属性与方法</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#66d9ef">@property</span> (<span style="color:#66d9ef">assign</span>) <span style="color:#66d9ef">id</span><span style="color:#f92672">&lt;</span>NSCacheDelegate<span style="color:#f92672">&gt;</span>delegate;
</code></pre></div><p>cache对象的代理 ， 用来即将清理cache的时候得到通知</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec">- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">cache:</span>(NSCache <span style="color:#f92672">*</span>)cache <span style="color:#a6e22e">willEvictObject:</span>(<span style="color:#66d9ef">id</span>)obj;
</code></pre></div><p>代理方法 ， 这里面不要对cache进行改动 ， 如果对象obj需要被持久化存储的话可以在这里进行操作</p>
<p>这里面有几种情况会导致该方法执行：</p>
<ul>
<li>手动移除（removeObjectForKey）</li>
<li>缓存超过设定的上线</li>
<li>App不活跃</li>
<li>系统内存爆炸</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#66d9ef">@property</span> <span style="color:#66d9ef">BOOL</span> evictsObjectsWithDiscardedContent;
</code></pre></div><p>该属性默认为True ， 表示在内存销毁时丢弃该对象 。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#66d9ef">@property</span> NSUInteger totalCostLimit;
</code></pre></div><p>总成本数 ， 用来设置最大缓存数量</p>
<h3 id="开始使用nscache">开始使用NSCache</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#75715e">//
</span><span style="color:#75715e">//  TDFSetPhoneNumController.m
</span><span style="color:#75715e">//  TDFLoginModule
</span><span style="color:#75715e">//
</span><span style="color:#75715e">//  Created by doubanjiang on 2017/6/5.
</span><span style="color:#75715e">//  Copyright © 2017年 doubanjiang. All rights reserved.
</span><span style="color:#75715e">//
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#import &#34;viewController.h&#34;
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">@interface</span> <span style="color:#a6e22e">viewController</span> () <span style="color:#f92672">&lt;</span>NSCacheDelegate<span style="color:#f92672">&gt;</span>
<span style="color:#66d9ef">@property</span> (<span style="color:#66d9ef">nonatomic</span> ,<span style="color:#66d9ef">strong</span>) NSCache <span style="color:#f92672">*</span>cache;
<span style="color:#66d9ef">@end</span>

<span style="color:#66d9ef">@implementation</span> <span style="color:#a6e22e">viewController</span>

- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">viewDidLoad</span> {
    
    [super viewDidLoad];
    
    [self beginCache];
}

- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">beginCache</span> {
    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">10</span>; i<span style="color:#f92672">++</span>) {
        NSString <span style="color:#f92672">*</span>obj <span style="color:#f92672">=</span> [NSString stringWithFormat:<span style="color:#e6db74">@&#34;object--%d&#34;</span>,i];
        [self.cache setObject:obj forKey:<span style="color:#ae81ff">@(</span>i<span style="color:#ae81ff">)</span> cost:<span style="color:#ae81ff">1</span>];
        NSLog(<span style="color:#e6db74">@&#34;%@ cached&#34;</span>,obj);
    }
}

<span style="color:#75715e">#pragma mark - NSCacheDelegate
</span><span style="color:#75715e"></span>
- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">cache:</span>(NSCache <span style="color:#f92672">*</span>)cache <span style="color:#a6e22e">willEvictObject:</span>(<span style="color:#66d9ef">id</span>)obj {
    
    <span style="color:#75715e">//evict : 驱逐
</span><span style="color:#75715e"></span>    NSLog(<span style="color:#e6db74">@&#34;%@&#34;</span>, [NSString stringWithFormat:<span style="color:#e6db74">@&#34;%@ will be evict&#34;</span>,obj]);
}


<span style="color:#75715e">#pragma mark - Getter
</span><span style="color:#75715e"></span>
- (NSCache <span style="color:#f92672">*</span>)<span style="color:#a6e22e">cache</span> {
    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>_cache) {
        _cache <span style="color:#f92672">=</span> [NSCache new];
        _cache.totalCostLimit <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>;
        _cache.delegate <span style="color:#f92672">=</span> self;
    }
    <span style="color:#66d9ef">return</span> _cache;
}
<span style="color:#66d9ef">@end</span>
</code></pre></div><p>我们会看到以下输出</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#ae81ff">2018</span><span style="color:#f92672">-</span><span style="color:#ae81ff">07</span><span style="color:#f92672">-</span><span style="color:#ae81ff">31</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">30</span><span style="color:#f92672">:</span><span style="color:#ae81ff">56.485719</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> Test_Example[<span style="color:#ae81ff">52839</span><span style="color:#f92672">:</span><span style="color:#ae81ff">214698</span>] object<span style="color:#f92672">--</span><span style="color:#ae81ff">0</span> cached
<span style="color:#ae81ff">2018</span><span style="color:#f92672">-</span><span style="color:#ae81ff">07</span><span style="color:#f92672">-</span><span style="color:#ae81ff">31</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">30</span><span style="color:#f92672">:</span><span style="color:#ae81ff">56.485904</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> Test_Example[<span style="color:#ae81ff">52839</span><span style="color:#f92672">:</span><span style="color:#ae81ff">214698</span>] object<span style="color:#f92672">--</span><span style="color:#ae81ff">1</span> cached
<span style="color:#ae81ff">2018</span><span style="color:#f92672">-</span><span style="color:#ae81ff">07</span><span style="color:#f92672">-</span><span style="color:#ae81ff">31</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">30</span><span style="color:#f92672">:</span><span style="color:#ae81ff">56.486024</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> Test_Example[<span style="color:#ae81ff">52839</span><span style="color:#f92672">:</span><span style="color:#ae81ff">214698</span>] object<span style="color:#f92672">--</span><span style="color:#ae81ff">2</span> cached
<span style="color:#ae81ff">2018</span><span style="color:#f92672">-</span><span style="color:#ae81ff">07</span><span style="color:#f92672">-</span><span style="color:#ae81ff">31</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">30</span><span style="color:#f92672">:</span><span style="color:#ae81ff">56.486113</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> Test_Example[<span style="color:#ae81ff">52839</span><span style="color:#f92672">:</span><span style="color:#ae81ff">214698</span>] object<span style="color:#f92672">--</span><span style="color:#ae81ff">3</span> cached
<span style="color:#ae81ff">2018</span><span style="color:#f92672">-</span><span style="color:#ae81ff">07</span><span style="color:#f92672">-</span><span style="color:#ae81ff">31</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">30</span><span style="color:#f92672">:</span><span style="color:#ae81ff">56.486254</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> Test_Example[<span style="color:#ae81ff">52839</span><span style="color:#f92672">:</span><span style="color:#ae81ff">214698</span>] object<span style="color:#f92672">--</span><span style="color:#ae81ff">4</span> cached
<span style="color:#ae81ff">2018</span><span style="color:#f92672">-</span><span style="color:#ae81ff">07</span><span style="color:#f92672">-</span><span style="color:#ae81ff">31</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">30</span><span style="color:#f92672">:</span><span style="color:#ae81ff">56.486382</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> Test_Example[<span style="color:#ae81ff">52839</span><span style="color:#f92672">:</span><span style="color:#ae81ff">214698</span>] object<span style="color:#f92672">--</span><span style="color:#ae81ff">0</span> will be evict
<span style="color:#ae81ff">2018</span><span style="color:#f92672">-</span><span style="color:#ae81ff">07</span><span style="color:#f92672">-</span><span style="color:#ae81ff">31</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">30</span><span style="color:#f92672">:</span><span style="color:#ae81ff">56.486480</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> Test_Example[<span style="color:#ae81ff">52839</span><span style="color:#f92672">:</span><span style="color:#ae81ff">214698</span>] object<span style="color:#f92672">--</span><span style="color:#ae81ff">5</span> cached
<span style="color:#ae81ff">2018</span><span style="color:#f92672">-</span><span style="color:#ae81ff">07</span><span style="color:#f92672">-</span><span style="color:#ae81ff">31</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">30</span><span style="color:#f92672">:</span><span style="color:#ae81ff">56.486598</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> Test_Example[<span style="color:#ae81ff">52839</span><span style="color:#f92672">:</span><span style="color:#ae81ff">214698</span>] object<span style="color:#f92672">--</span><span style="color:#ae81ff">1</span> will be evict
<span style="color:#ae81ff">2018</span><span style="color:#f92672">-</span><span style="color:#ae81ff">07</span><span style="color:#f92672">-</span><span style="color:#ae81ff">31</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">30</span><span style="color:#f92672">:</span><span style="color:#ae81ff">56.486681</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> Test_Example[<span style="color:#ae81ff">52839</span><span style="color:#f92672">:</span><span style="color:#ae81ff">214698</span>] object<span style="color:#f92672">--</span><span style="color:#ae81ff">6</span> cached
<span style="color:#ae81ff">2018</span><span style="color:#f92672">-</span><span style="color:#ae81ff">07</span><span style="color:#f92672">-</span><span style="color:#ae81ff">31</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">30</span><span style="color:#f92672">:</span><span style="color:#ae81ff">56.486795</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> Test_Example[<span style="color:#ae81ff">52839</span><span style="color:#f92672">:</span><span style="color:#ae81ff">214698</span>] object<span style="color:#f92672">--</span><span style="color:#ae81ff">2</span> will be evict
<span style="color:#ae81ff">2018</span><span style="color:#f92672">-</span><span style="color:#ae81ff">07</span><span style="color:#f92672">-</span><span style="color:#ae81ff">31</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">30</span><span style="color:#f92672">:</span><span style="color:#ae81ff">56.486888</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> Test_Example[<span style="color:#ae81ff">52839</span><span style="color:#f92672">:</span><span style="color:#ae81ff">214698</span>] object<span style="color:#f92672">--</span><span style="color:#ae81ff">7</span> cached
<span style="color:#ae81ff">2018</span><span style="color:#f92672">-</span><span style="color:#ae81ff">07</span><span style="color:#f92672">-</span><span style="color:#ae81ff">31</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">30</span><span style="color:#f92672">:</span><span style="color:#ae81ff">56.486995</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> Test_Example[<span style="color:#ae81ff">52839</span><span style="color:#f92672">:</span><span style="color:#ae81ff">214698</span>] object<span style="color:#f92672">--</span><span style="color:#ae81ff">3</span> will be evict
<span style="color:#ae81ff">2018</span><span style="color:#f92672">-</span><span style="color:#ae81ff">07</span><span style="color:#f92672">-</span><span style="color:#ae81ff">31</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">30</span><span style="color:#f92672">:</span><span style="color:#ae81ff">56.487190</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> Test_Example[<span style="color:#ae81ff">52839</span><span style="color:#f92672">:</span><span style="color:#ae81ff">214698</span>] object<span style="color:#f92672">--</span><span style="color:#ae81ff">8</span> cached
<span style="color:#ae81ff">2018</span><span style="color:#f92672">-</span><span style="color:#ae81ff">07</span><span style="color:#f92672">-</span><span style="color:#ae81ff">31</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">30</span><span style="color:#f92672">:</span><span style="color:#ae81ff">56.487446</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> Test_Example[<span style="color:#ae81ff">52839</span><span style="color:#f92672">:</span><span style="color:#ae81ff">214698</span>] object<span style="color:#f92672">--</span><span style="color:#ae81ff">4</span> will be evict
<span style="color:#ae81ff">2018</span><span style="color:#f92672">-</span><span style="color:#ae81ff">07</span><span style="color:#f92672">-</span><span style="color:#ae81ff">31</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">30</span><span style="color:#f92672">:</span><span style="color:#ae81ff">56.487604</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> Test_Example[<span style="color:#ae81ff">52839</span><span style="color:#f92672">:</span><span style="color:#ae81ff">214698</span>] object<span style="color:#f92672">--</span><span style="color:#ae81ff">9</span> cached
</code></pre></div><h3 id="总结">总结</h3>
<p>经过实验我们发现NSCache使用上性价比还是比较高的，可以在项目里放心去用，可以提升app的性能。</p>

</div>


        
<div class="section bottom-menu">
    
<hr />
<p>


    
        <a href="http://example.org/posts">back</a>
        
            &#183;
        
    

    
        
            <a href="http://example.org/posts">posts</a>
        
    
    
        
            &#183; 
            <a href="http://example.org/memoryManage">memoryManage</a>
        
            &#183; 
            <a href="http://example.org/portfolio">portfolio</a>
        
            &#183; 
            <a href="http://example.org/about">who is Cb7d?</a>
        
    
    &#183; 
    <a href="http://example.org/">
        main
    </a>

</p>
</div>


        <div class="section footer">Cb7d &lsquo;s blog.</div>
    </div>
</body>

</html>