<!DOCTYPE html>
<html>

<head>
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="description" content="A new Hugo site.">
<title>
ObjC 中的原子性 - Cb7d
</title>




<link rel="shortcut icon" href="https://min.felixplus.top/public/icon/man_icon_square.JPG?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ZYHZHANGYUNHAO931119%2F20200223%2F%2Fs3%2Faws4_request&amp;X-Amz-Date=20200223T024742Z&amp;X-Amz-Expires=432000&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=c5cfbe0ee2c297b46bcf68413178d4f0752d10171e51fe31713b02384b2617e3">








<link rel="stylesheet" href="http://example.org/css/main.min.81bbafc4df93b11c1c3e2449464373c384aa4903731b4fc7a77dfcdd979e184f.css" integrity="sha256-gbuvxN&#43;TsRwcPiRJRkNzw4SqSQNzG0/Hp3383ZeeGE8=" crossorigin="anonymous" media="screen">



 

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Didact+Gothic">

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://example.org/tn.png"/>

<meta name="twitter:title" content="ObjC 中的原子性"/>
<meta name="twitter:description" content="atomic 前言 在使用 @property 修饰成员变量的时候，会设置一个默认的缺省值 atomic
@property (assign) NSInteger ticketNum; 以上写法等同于
@property (atomic, assign) NSInteger ticketNum; atomic ，顾名思义是原子的，也就是说使用 atomic 修饰能够保证属性的线程安全，那么它真的做到了吗
安全性证明 首先定义一个电影院类，向电影院添加一个总票数的属性
#import &lt;Foundation/Foundation.h&gt;  NS_ASSUME_NONNULL_BEGIN @interface Theater : NSObject @property (atomic, assign) NSInteger ticketNum; @end NS_ASSUME_NONNULL_END 接下来我们模拟卖票的过程
Theater *theater = [[Theater alloc] init]; // 定义总票数为2000 theater.ticketNum = 2000; // 并发队列用于卖票 dispatch_queue_t concurrentQueue = dispatch_queue_create(&#34;com.test.example0&#34;, DISPATCH_QUEUE_CONCURRENT); // 将总票数分为4部分分别添加到并发队列执行卖票操作 for (int i = 0; i &lt; 4; i&#43;&#43;) { dispatch_async(concurrentQueue, ^{ for (int i = 0; i &lt; 500; i&#43;&#43;) { theater."/>

<meta property="og:title" content="ObjC 中的原子性" />
<meta property="og:description" content="atomic 前言 在使用 @property 修饰成员变量的时候，会设置一个默认的缺省值 atomic
@property (assign) NSInteger ticketNum; 以上写法等同于
@property (atomic, assign) NSInteger ticketNum; atomic ，顾名思义是原子的，也就是说使用 atomic 修饰能够保证属性的线程安全，那么它真的做到了吗
安全性证明 首先定义一个电影院类，向电影院添加一个总票数的属性
#import &lt;Foundation/Foundation.h&gt;  NS_ASSUME_NONNULL_BEGIN @interface Theater : NSObject @property (atomic, assign) NSInteger ticketNum; @end NS_ASSUME_NONNULL_END 接下来我们模拟卖票的过程
Theater *theater = [[Theater alloc] init]; // 定义总票数为2000 theater.ticketNum = 2000; // 并发队列用于卖票 dispatch_queue_t concurrentQueue = dispatch_queue_create(&#34;com.test.example0&#34;, DISPATCH_QUEUE_CONCURRENT); // 将总票数分为4部分分别添加到并发队列执行卖票操作 for (int i = 0; i &lt; 4; i&#43;&#43;) { dispatch_async(concurrentQueue, ^{ for (int i = 0; i &lt; 500; i&#43;&#43;) { theater." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/posts/atomic/" />
<meta property="og:image" content="http://example.org/tn.png"/>
<meta property="article:published_time" content="2020-02-19T10:46:42+08:00" />
<meta property="article:modified_time" content="2020-02-19T10:46:42+08:00" /><meta property="og:site_name" content="Cb7d" />


    

    
    
    
    <title>
        
        ObjC 中的原子性
        
    </title>
</head>

<body>
    <div class="wrap">
        <div class="section" id="title">ObjC 中的原子性</div>

        
<div class="section" id="content">
    Wed Feb 19, 2020 &#183; 715 words
    <div class="tag-container">
        
        
        <span class="tag">
            <a href="http://example.org/tags/blog/">
                blog
            </a>
        </span>
        
        
        
        <span class="tag">
            <a href="http://example.org/tags/ios/">
                iOS
            </a>
        </span>
        
        
        
        <span class="tag">
            <a href="http://example.org/tags/objc/">
                ObjC
            </a>
        </span>
        
        
        
        <span class="tag">
            <a href="http://example.org/tags/thread/">
                thread
            </a>
        </span>
        
        
    </div>
    <hr/>
    <h1 id="atomic">atomic</h1>
<h2 id="前言">前言</h2>
<p>在使用 <code>@property</code> 修饰成员变量的时候，会设置一个默认的缺省值 <strong>atomic</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#66d9ef">@property</span> (<span style="color:#66d9ef">assign</span>) NSInteger ticketNum;
</code></pre></div><p>以上写法等同于</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#66d9ef">@property</span> (<span style="color:#66d9ef">atomic</span>, <span style="color:#66d9ef">assign</span>) NSInteger ticketNum;
</code></pre></div><p><strong>atomic</strong> ，顾名思义是原子的，也就是说使用 atomic 修饰能够保证属性的线程安全，那么它真的做到了吗</p>
<h2 id="安全性证明">安全性证明</h2>
<p>首先定义一个电影院类，向电影院添加一个总票数的属性</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#75715e">#import &lt;Foundation/Foundation.h&gt;
</span><span style="color:#75715e"></span>
NS_ASSUME_NONNULL_BEGIN

<span style="color:#66d9ef">@interface</span> <span style="color:#a6e22e">Theater</span> : <span style="color:#a6e22e">NSObject</span>

<span style="color:#66d9ef">@property</span> (<span style="color:#66d9ef">atomic</span>, <span style="color:#66d9ef">assign</span>) NSInteger ticketNum;

<span style="color:#66d9ef">@end</span>

NS_ASSUME_NONNULL_END
</code></pre></div><p>接下来我们模拟卖票的过程</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec">Theater <span style="color:#f92672">*</span>theater <span style="color:#f92672">=</span> [[Theater alloc] init];
<span style="color:#75715e">// 定义总票数为2000
</span><span style="color:#75715e"></span>theater.ticketNum <span style="color:#f92672">=</span> <span style="color:#ae81ff">2000</span>;
<span style="color:#75715e">// 并发队列用于卖票
</span><span style="color:#75715e"></span>dispatch_queue_t concurrentQueue <span style="color:#f92672">=</span> dispatch_queue_create(<span style="color:#e6db74">&#34;com.test.example0&#34;</span>, DISPATCH_QUEUE_CONCURRENT);

<span style="color:#75715e">// 将总票数分为4部分分别添加到并发队列执行卖票操作
</span><span style="color:#75715e"></span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">4</span>; i<span style="color:#f92672">++</span>) {
  dispatch_async(concurrentQueue, <span style="color:#f92672">^</span>{
    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">500</span>; i<span style="color:#f92672">++</span>) {
      theater.ticketNum<span style="color:#f92672">--</span>;
      NSLog(<span style="color:#e6db74">@&#34;sold one ticket ,left: %ld&#34;</span>, (<span style="color:#66d9ef">long</span>)theater.ticketNum);
    }
  });
}

<span style="color:#75715e">// 使用栅栏函数等待前面任务完成，最后打印卖完票后的总票数
</span><span style="color:#75715e"></span>dispatch_barrier_sync(concurrentQueue, <span style="color:#f92672">^</span>{
  NSLog(<span style="color:#e6db74">@&#34;%ld&#34;</span>, (<span style="color:#66d9ef">long</span>)theater.ticketNum);
});
</code></pre></div><p>你可能会认为，最后打印的一定是0了，但是实际上我们看到</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#ae81ff">2019</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">21</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">47.051759</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> ObjCSample[<span style="color:#ae81ff">8432</span><span style="color:#f92672">:</span><span style="color:#ae81ff">89258</span>] sold one ticket ,left: <span style="color:#ae81ff">93</span>
<span style="color:#ae81ff">2019</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">21</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">47.051763</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> ObjCSample[<span style="color:#ae81ff">8432</span><span style="color:#f92672">:</span><span style="color:#ae81ff">89260</span>] sold one ticket ,left: <span style="color:#ae81ff">91</span>
<span style="color:#ae81ff">2019</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">21</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">47.051764</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> ObjCSample[<span style="color:#ae81ff">8432</span><span style="color:#f92672">:</span><span style="color:#ae81ff">89259</span>] sold one ticket ,left: <span style="color:#ae81ff">92</span>
<span style="color:#ae81ff">2019</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">21</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">47.051769</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> ObjCSample[<span style="color:#ae81ff">8432</span><span style="color:#f92672">:</span><span style="color:#ae81ff">89258</span>] sold one ticket ,left: <span style="color:#ae81ff">90</span>
<span style="color:#ae81ff">2019</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">21</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">47.051771</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> ObjCSample[<span style="color:#ae81ff">8432</span><span style="color:#f92672">:</span><span style="color:#ae81ff">89260</span>] sold one ticket ,left: <span style="color:#ae81ff">89</span>
<span style="color:#ae81ff">2019</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">21</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">47.051911</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> ObjCSample[<span style="color:#ae81ff">8432</span><span style="color:#f92672">:</span><span style="color:#ae81ff">89260</span>] sold one ticket ,left: <span style="color:#ae81ff">86</span>
<span style="color:#ae81ff">2019</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">21</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">47.051936</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> ObjCSample[<span style="color:#ae81ff">8432</span><span style="color:#f92672">:</span><span style="color:#ae81ff">89260</span>] sold one ticket ,left: <span style="color:#ae81ff">85</span>
<span style="color:#ae81ff">2019</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">21</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">47.051780</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> ObjCSample[<span style="color:#ae81ff">8432</span><span style="color:#f92672">:</span><span style="color:#ae81ff">89258</span>] sold one ticket ,left: <span style="color:#ae81ff">87</span>
<span style="color:#ae81ff">2019</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">21</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">47.051965</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> ObjCSample[<span style="color:#ae81ff">8432</span><span style="color:#f92672">:</span><span style="color:#ae81ff">89260</span>] sold one ticket ,left: <span style="color:#ae81ff">84</span>
<span style="color:#ae81ff">2019</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">21</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">47.051784</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> ObjCSample[<span style="color:#ae81ff">8432</span><span style="color:#f92672">:</span><span style="color:#ae81ff">89259</span>] sold one ticket ,left: <span style="color:#ae81ff">88</span>
<span style="color:#ae81ff">2019</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">21</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">47.051974</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> ObjCSample[<span style="color:#ae81ff">8432</span><span style="color:#f92672">:</span><span style="color:#ae81ff">89260</span>] sold one ticket ,left: <span style="color:#ae81ff">83</span>
<span style="color:#ae81ff">2019</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">21</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">47.051983</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> ObjCSample[<span style="color:#ae81ff">8432</span><span style="color:#f92672">:</span><span style="color:#ae81ff">89258</span>] sold one ticket ,left: <span style="color:#ae81ff">82</span>
<span style="color:#ae81ff">2019</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">21</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">47.051992</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> ObjCSample[<span style="color:#ae81ff">8432</span><span style="color:#f92672">:</span><span style="color:#ae81ff">89260</span>] sold one ticket ,left: <span style="color:#ae81ff">81</span>
<span style="color:#ae81ff">2019</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">21</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">47.051998</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> ObjCSample[<span style="color:#ae81ff">8432</span><span style="color:#f92672">:</span><span style="color:#ae81ff">89258</span>] sold one ticket ,left: <span style="color:#ae81ff">80</span>
<span style="color:#ae81ff">2019</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">21</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">47.052003</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> ObjCSample[<span style="color:#ae81ff">8432</span><span style="color:#f92672">:</span><span style="color:#ae81ff">89260</span>] sold one ticket ,left: <span style="color:#ae81ff">79</span>
<span style="color:#ae81ff">2019</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">21</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">47.052005</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> ObjCSample[<span style="color:#ae81ff">8432</span><span style="color:#f92672">:</span><span style="color:#ae81ff">89258</span>] sold one ticket ,left: <span style="color:#ae81ff">78</span>
<span style="color:#ae81ff">2019</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">21</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">47.052009</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> ObjCSample[<span style="color:#ae81ff">8432</span><span style="color:#f92672">:</span><span style="color:#ae81ff">89260</span>] sold one ticket ,left: <span style="color:#ae81ff">77</span>
<span style="color:#ae81ff">2019</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">21</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">47.052011</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> ObjCSample[<span style="color:#ae81ff">8432</span><span style="color:#f92672">:</span><span style="color:#ae81ff">89258</span>] sold one ticket ,left: <span style="color:#ae81ff">76</span>
<span style="color:#ae81ff">2019</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">21</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">47.052015</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> ObjCSample[<span style="color:#ae81ff">8432</span><span style="color:#f92672">:</span><span style="color:#ae81ff">89260</span>] sold one ticket ,left: <span style="color:#ae81ff">75</span>
<span style="color:#ae81ff">2019</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">21</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">47.052125</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> ObjCSample[<span style="color:#ae81ff">8432</span><span style="color:#f92672">:</span><span style="color:#ae81ff">89260</span>] sold one ticket ,left: <span style="color:#ae81ff">74</span>
<span style="color:#ae81ff">2019</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">21</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">47.052141</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> ObjCSample[<span style="color:#ae81ff">8432</span><span style="color:#f92672">:</span><span style="color:#ae81ff">89260</span>] sold one ticket ,left: <span style="color:#ae81ff">72</span>
<span style="color:#ae81ff">2019</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">21</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">47.052138</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> ObjCSample[<span style="color:#ae81ff">8432</span><span style="color:#f92672">:</span><span style="color:#ae81ff">89258</span>] sold one ticket ,left: <span style="color:#ae81ff">73</span>
<span style="color:#ae81ff">2019</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">21</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">47.052297</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> ObjCSample[<span style="color:#ae81ff">8432</span><span style="color:#f92672">:</span><span style="color:#ae81ff">88989</span>] <span style="color:#ae81ff">72</span>
</code></pre></div><p>输出竟然不是0，那么这是为什么呢，我们可以看下苹果提供的<a href="https://opensource.apple.com/tarballs/objc4/">源码</a></p>
<h2 id="查看源码">查看源码</h2>
<p>找到 objc-accessors.mm 这个文件，可以看到如下方法的定义</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#66d9ef">id</span> <span style="color:#a6e22e">objc_getProperty</span>(<span style="color:#66d9ef">id</span> self, <span style="color:#66d9ef">SEL</span> _cmd, ptrdiff_t offset, <span style="color:#66d9ef">BOOL</span> <span style="color:#66d9ef">atomic</span>) {
    <span style="color:#66d9ef">if</span> (offset <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
        <span style="color:#66d9ef">return</span> object_getClass(self);
    }

    <span style="color:#75715e">// Retain release world
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">id</span> <span style="color:#f92672">*</span>slot <span style="color:#f92672">=</span> (<span style="color:#66d9ef">id</span><span style="color:#f92672">*</span>) ((<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)self <span style="color:#f92672">+</span> offset);
    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#66d9ef">atomic</span>) <span style="color:#66d9ef">return</span> <span style="color:#f92672">*</span>slot;
        
    <span style="color:#75715e">// Atomic retain release world
</span><span style="color:#75715e"></span>    spinlock_t<span style="color:#f92672">&amp;</span> slotlock <span style="color:#f92672">=</span> PropertyLocks[slot];
    slotlock.lock();
    <span style="color:#66d9ef">id</span> value <span style="color:#f92672">=</span> objc_retain(<span style="color:#f92672">*</span>slot);
    slotlock.unlock();
    
    <span style="color:#75715e">// for performance, we (safely) issue the autorelease OUTSIDE of the spinlock.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> objc_autoreleaseReturnValue(value);
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">objc_setProperty_atomic</span>(<span style="color:#66d9ef">id</span> self, <span style="color:#66d9ef">SEL</span> _cmd, <span style="color:#66d9ef">id</span> newValue, ptrdiff_t offset)
{
    reallySetProperty(self, _cmd, newValue, offset, true, false, false);
}

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">reallySetProperty</span>(<span style="color:#66d9ef">id</span> self, <span style="color:#66d9ef">SEL</span> _cmd, <span style="color:#66d9ef">id</span> newValue, ptrdiff_t offset, <span style="color:#66d9ef">bool</span> <span style="color:#66d9ef">atomic</span>, <span style="color:#66d9ef">bool</span> <span style="color:#66d9ef">copy</span>, <span style="color:#66d9ef">bool</span> mutableCopy)
{
    <span style="color:#66d9ef">if</span> (offset <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
        object_setClass(self, newValue);
        <span style="color:#66d9ef">return</span>;
    }

    <span style="color:#66d9ef">id</span> oldValue;
    <span style="color:#66d9ef">id</span> <span style="color:#f92672">*</span>slot <span style="color:#f92672">=</span> (<span style="color:#66d9ef">id</span><span style="color:#f92672">*</span>) ((<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)self <span style="color:#f92672">+</span> offset);

    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">copy</span>) {
        newValue <span style="color:#f92672">=</span> [newValue copyWithZone:nil];
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (mutableCopy) {
        newValue <span style="color:#f92672">=</span> [newValue mutableCopyWithZone:nil];
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>slot <span style="color:#f92672">==</span> newValue) <span style="color:#66d9ef">return</span>;
        newValue <span style="color:#f92672">=</span> objc_retain(newValue);
    }

    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#66d9ef">atomic</span>) {
        oldValue <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>slot;
        <span style="color:#f92672">*</span>slot <span style="color:#f92672">=</span> newValue;
    } <span style="color:#66d9ef">else</span> {
        spinlock_t<span style="color:#f92672">&amp;</span> slotlock <span style="color:#f92672">=</span> PropertyLocks[slot];
        slotlock.lock();
        oldValue <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>slot;
        <span style="color:#f92672">*</span>slot <span style="color:#f92672">=</span> newValue;        
        slotlock.unlock();
    }

    objc_release(oldValue);
}
</code></pre></div><p>这里在对atomic修饰的属性进行读写的时候，使用了<code>spinlock_t</code>进行加锁操作，那么为什么我们上面实践的代码证明了在并发的情况下atomic是无效的呢？</p>
<p>原因就是 <code>theater.ticketNum--</code> 这段代码，我们看看它都做了什么</p>
<ol>
<li>取出 ticketNum</li>
<li>ticketNum 的值 减1</li>
<li>ticketNum 设置为新值</li>
</ol>
<p>单独的get或set方法是有保证线程安全的，但是我们在并发的情况下边读边写，这就有可能导致这种情况下出现</p>
<blockquote>
<p>并发线程中的任务1和任务2同时获取了 ticketNum 的值，比如233，这时任务1向ticketNum写入232，任务2也向ticketNum写入了232，我们期望的递减就没有发生</p>
</blockquote>
<h2 id="修改方案">修改方案</h2>
<p>最终我们发现，就是由于读写不同步导致atomic不生效，所以我们只需要对 <code>theater.ticketNum--</code> 这个操作加锁就好了</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">4</span>; i<span style="color:#f92672">++</span>) {
  dispatch_async(concurrentQueue, <span style="color:#f92672">^</span>{
    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">500</span>; i<span style="color:#f92672">++</span>) {
      <span style="color:#66d9ef">@synchronized</span> (theater) {
        theater.ticketNum<span style="color:#f92672">--</span>;
      }
      NSLog(<span style="color:#e6db74">@&#34;sold one ticket ,left: %ld&#34;</span>, (<span style="color:#66d9ef">long</span>)theater.ticketNum);
    }
  });
}
</code></pre></div><h2 id="其他">其他</h2>
<p>在阅读源代码的时候我们可以看到对于原子性修饰的property读写，是使用了spinlock_t加锁的，突然想起来之前看到过的一篇文章，大概意思就是说spinlock_t这个自旋锁在一定情况下会引起死锁。</p>
<blockquote>
<p>新版 iOS 中，系统维护了 5 个不同的线程优先级/QoS: background，utility，default，user-initiated，user-interactive。高优先级线程始终会在低优先级线程前执行，一个线程不会受到比它更低优先级线程的干扰。这种线程调度算法会产生潜在的优先级反转问题，从而破坏了 spin lock。</p>
<p>具体来说，如果一个低优先级的线程获得锁并访问共享资源，这时一个高优先级的线程也尝试获得这个锁，它会处于 spin lock 的忙等状态从而占用大量 CPU。此时低优先级线程无法与高优先级线程争夺 CPU 时间，从而导致任务迟迟完不成、无法释放 lock。这并不只是理论上的问题，libobjc 已经遇到了很多次这个问题了，于是苹果的工程师停用了 OSSpinLock。</p>
</blockquote>
<p>可是我们在阅读源码的时候看到明明用的还是spinlock，不是说不安全了吗，</p>
<p>objc-os.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">using</span> spinlock_t <span style="color:#f92672">=</span> mutex_tt<span style="color:#f92672">&lt;</span>LOCKDEBUG<span style="color:#f92672">&gt;</span>;
<span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;objc-lockdebug.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">bool</span> Debug<span style="color:#f92672">&gt;</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">mutex_tt</span> <span style="color:#f92672">:</span> nocopy_t {
    os_unfair_lock mLock;
 <span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    <span style="color:#66d9ef">constexpr</span> mutex_tt() <span style="color:#f92672">:</span> mLock(OS_UNFAIR_LOCK_INIT) {
        lockdebug_remember_mutex(<span style="color:#66d9ef">this</span>);
    }

    <span style="color:#66d9ef">constexpr</span> <span style="color:#a6e22e">mutex_tt</span>(<span style="color:#66d9ef">const</span> fork_unsafe_lock_t unsafe) <span style="color:#f92672">:</span> mLock(OS_UNFAIR_LOCK_INIT) { }

    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">lock</span>() {
        lockdebug_mutex_lock(<span style="color:#66d9ef">this</span>);

        os_unfair_lock_lock_with_options_inline
            (<span style="color:#f92672">&amp;</span>mLock, OS_UNFAIR_LOCK_DATA_SYNCHRONIZATION);
    }

    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">unlock</span>() {
        lockdebug_mutex_unlock(<span style="color:#66d9ef">this</span>);

        os_unfair_lock_unlock_inline(<span style="color:#f92672">&amp;</span>mLock);
    }

    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">forceReset</span>() {
        lockdebug_mutex_unlock(<span style="color:#66d9ef">this</span>);

        bzero(<span style="color:#f92672">&amp;</span>mLock, <span style="color:#66d9ef">sizeof</span>(mLock));
        mLock <span style="color:#f92672">=</span> os_unfair_lock OS_UNFAIR_LOCK_INIT;
    }

    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">assertLocked</span>() {
        lockdebug_mutex_assert_locked(<span style="color:#66d9ef">this</span>);
    }

    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">assertUnlocked</span>() {
        lockdebug_mutex_assert_unlocked(<span style="color:#66d9ef">this</span>);
    }


    <span style="color:#75715e">// Address-ordered lock discipline for a pair of locks.
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">lockTwo</span>(mutex_tt <span style="color:#f92672">*</span>lock1, mutex_tt <span style="color:#f92672">*</span>lock2) {
        <span style="color:#66d9ef">if</span> (lock1 <span style="color:#f92672">&lt;</span> lock2) {
            lock1<span style="color:#f92672">-&gt;</span>lock();
            lock2<span style="color:#f92672">-&gt;</span>lock();
        } <span style="color:#66d9ef">else</span> {
            lock2<span style="color:#f92672">-&gt;</span>lock();
            <span style="color:#66d9ef">if</span> (lock2 <span style="color:#f92672">!=</span> lock1) lock1<span style="color:#f92672">-&gt;</span>lock(); 
        }
    }

    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">unlockTwo</span>(mutex_tt <span style="color:#f92672">*</span>lock1, mutex_tt <span style="color:#f92672">*</span>lock2) {
        lock1<span style="color:#f92672">-&gt;</span>unlock();
        <span style="color:#66d9ef">if</span> (lock2 <span style="color:#f92672">!=</span> lock1) lock2<span style="color:#f92672">-&gt;</span>unlock();
    }

    <span style="color:#75715e">// Scoped lock and unlock
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">locker</span> <span style="color:#f92672">:</span> nocopy_t {
        mutex_tt<span style="color:#f92672">&amp;</span> lock;
    <span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
        locker(mutex_tt<span style="color:#f92672">&amp;</span> newLock) 
            <span style="color:#f92672">:</span> lock(newLock) { lock.lock(); }
        <span style="color:#f92672">~</span>locker() { lock.unlock(); }
    };

    <span style="color:#75715e">// Either scoped lock and unlock, or NOP.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">conditional_locker</span> <span style="color:#f92672">:</span> nocopy_t {
        mutex_tt<span style="color:#f92672">&amp;</span> lock;
        <span style="color:#66d9ef">bool</span> didLock;
    <span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
        conditional_locker(mutex_tt<span style="color:#f92672">&amp;</span> newLock, <span style="color:#66d9ef">bool</span> shouldLock)
            <span style="color:#f92672">:</span> lock(newLock), didLock(shouldLock)
        {
            <span style="color:#66d9ef">if</span> (shouldLock) lock.lock();
        }
        <span style="color:#f92672">~</span>conditional_locker() { <span style="color:#66d9ef">if</span> (didLock) lock.unlock(); }
    };
};
</code></pre></div><p>无语，内部偷偷换成 os_unfair_lock ，一个改进版的互斥锁， 外面还不改名字，真的骚</p>
<h2 id="总结">总结</h2>
<p>总之用atomic修饰property并没有什么用处，除非你的属性是只读的，不然在读写操作的时候我们还是要自己去加锁来保证线程安全，还有一点非常重要，就是不确定的东西多去看看源代码，不然还要纠结半天。</p>

</div>


        
<div class="section bottom-menu">
    
<hr />
<p>


    
        <a href="http://example.org/posts">back</a>
        
            &#183;
        
    

    
        
            <a href="http://example.org/posts">posts</a>
        
    
    
        
            &#183; 
            <a href="http://example.org/memoryManage">memoryManage</a>
        
            &#183; 
            <a href="http://example.org/portfolio">portfolio</a>
        
            &#183; 
            <a href="http://example.org/about">who is Cb7d?</a>
        
    
    &#183; 
    <a href="http://example.org/">
        main
    </a>

</p>
</div>


        <div class="section footer">Cb7d &lsquo;s blog.</div>
    </div>
</body>

</html>