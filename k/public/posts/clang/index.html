<!DOCTYPE html>
<html>

<head>
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="description" content="Cb7d &#39;s blog">
<title>
Clang简单上手 - Cb7d
</title>




<link rel="shortcut icon" href="https://min.felixplus.top/public/icon/man_icon_square.JPG?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ZYHZHANGYUNHAO931119%2F20200223%2F%2Fs3%2Faws4_request&amp;X-Amz-Date=20200223T024742Z&amp;X-Amz-Expires=432000&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=c5cfbe0ee2c297b46bcf68413178d4f0752d10171e51fe31713b02384b2617e3">








<link rel="stylesheet" href="http://example.org/css/main.min.81bbafc4df93b11c1c3e2449464373c384aa4903731b4fc7a77dfcdd979e184f.css" integrity="sha256-gbuvxN&#43;TsRwcPiRJRkNzw4SqSQNzG0/Hp3383ZeeGE8=" crossorigin="anonymous" media="screen">



 

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Didact+Gothic">

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://example.org/tn.png"/>

<meta name="twitter:title" content="Clang简单上手"/>
<meta name="twitter:description" content="Clang 作为一个iOS工程师，每次看到Xcode在进行漫长的编译的时候总是忍不住想深究一下自己手写的BUG是如何被生成的，所以下定决定研究一下我们的编译器
要探究首先要知道我们使用的是LLVM编译器
LLVM（Low Level Virtual Machine）  LLVM是一个自由软件项目，它是一种编译器基础设施，以C&#43;&#43;写成，包含一系列模块化的编译器组件和工具链，用来开发编译器前端和后端。它是为了任意一种编程语言而写成的程序，利用虚拟技术创造出编译时期、链接时期、运行时期以及“闲置时期”的最优化。它最早以C/C&#43;&#43;为实现对象，而当前它已支持包括ActionScript、Ada、D语言、Fortran、GLSL、Haskell、Java字节码、Objective-C、Swift、Python、Ruby、Rust、Scala以及C#等语言。
 以上摘自维基百科
几种编译器简介 目前市面上常见的编译器有以下两种
 GCC（GNU Compiler Collection） LLVM  LLVM 我们上面已经稍微介绍过了，下面引用维基百科对GCC的定义
 GNU编译器套装（英语：GNU Compiler Collection，缩写为GCC），指一套编程语言编译器，以GPL及LGPL许可证所发行的自由软件，也是GNU项目的关键部分，也是GNU工具链的主要组成部分之一。GCC（特别是其中的C语言编译器）也常被认为是跨平台编译器的事实标准。1985年由理查德·马修·斯托曼开始发展，现在由自由软件基金会负责维护工作。 原名为GNU C语言编译器（GNU C Compiler），因为它原本只能处理C语言。GCC在发布后很快地得到扩展，变得可处理C&#43;&#43;。之后也变得可处理Fortran、Pascal、Objective-C、Java、Ada，Go与其他语言。 许多操作系统，包括许多类Unix系统，如Linux及BSD家族都采用GCC作为标准编译器。
 LLVM与GCC 我们现在所使用的Xcode采用的是LLVM，以前曾经使用过GCC，见下表
   Xcode 版本 应用编译器     &lt; Xcode3 GCC   Xcode3 GCC &#43; LLVM   Xcode4.2 默认LLVM-Clang   &gt; Xcode5 废弃GCC    那么，同样是编译器，为何Xcode最终选择LLVM而舍弃Clang呢
 Apple对Objective-C新增的特性，GCC并未配合给予实现 GCC编译器前后端代码耦合度过高 license GCC限制了LLVM-GCC的开发  LLVM 设计思想 以下是传统的三相设计思想"/>

<meta property="og:title" content="Clang简单上手" />
<meta property="og:description" content="Clang 作为一个iOS工程师，每次看到Xcode在进行漫长的编译的时候总是忍不住想深究一下自己手写的BUG是如何被生成的，所以下定决定研究一下我们的编译器
要探究首先要知道我们使用的是LLVM编译器
LLVM（Low Level Virtual Machine）  LLVM是一个自由软件项目，它是一种编译器基础设施，以C&#43;&#43;写成，包含一系列模块化的编译器组件和工具链，用来开发编译器前端和后端。它是为了任意一种编程语言而写成的程序，利用虚拟技术创造出编译时期、链接时期、运行时期以及“闲置时期”的最优化。它最早以C/C&#43;&#43;为实现对象，而当前它已支持包括ActionScript、Ada、D语言、Fortran、GLSL、Haskell、Java字节码、Objective-C、Swift、Python、Ruby、Rust、Scala以及C#等语言。
 以上摘自维基百科
几种编译器简介 目前市面上常见的编译器有以下两种
 GCC（GNU Compiler Collection） LLVM  LLVM 我们上面已经稍微介绍过了，下面引用维基百科对GCC的定义
 GNU编译器套装（英语：GNU Compiler Collection，缩写为GCC），指一套编程语言编译器，以GPL及LGPL许可证所发行的自由软件，也是GNU项目的关键部分，也是GNU工具链的主要组成部分之一。GCC（特别是其中的C语言编译器）也常被认为是跨平台编译器的事实标准。1985年由理查德·马修·斯托曼开始发展，现在由自由软件基金会负责维护工作。 原名为GNU C语言编译器（GNU C Compiler），因为它原本只能处理C语言。GCC在发布后很快地得到扩展，变得可处理C&#43;&#43;。之后也变得可处理Fortran、Pascal、Objective-C、Java、Ada，Go与其他语言。 许多操作系统，包括许多类Unix系统，如Linux及BSD家族都采用GCC作为标准编译器。
 LLVM与GCC 我们现在所使用的Xcode采用的是LLVM，以前曾经使用过GCC，见下表
   Xcode 版本 应用编译器     &lt; Xcode3 GCC   Xcode3 GCC &#43; LLVM   Xcode4.2 默认LLVM-Clang   &gt; Xcode5 废弃GCC    那么，同样是编译器，为何Xcode最终选择LLVM而舍弃Clang呢
 Apple对Objective-C新增的特性，GCC并未配合给予实现 GCC编译器前后端代码耦合度过高 license GCC限制了LLVM-GCC的开发  LLVM 设计思想 以下是传统的三相设计思想" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/posts/clang/" />
<meta property="og:image" content="http://example.org/tn.png"/>
<meta property="article:published_time" content="2018-06-11T10:46:42+08:00" />
<meta property="article:modified_time" content="2018-06-11T10:46:42+08:00" /><meta property="og:site_name" content="Cb7d &#39;s blog" />


    

    
    
    
    <title>
        
        Clang简单上手
        
    </title>
</head>

<body>
    <div class="wrap">
        <div class="section" id="title">Clang简单上手</div>

        
<div class="section" id="content">
    Mon Jun 11, 2018 &#183; 1419 words
    <div class="tag-container">
        
        
        <span class="tag">
            <a href="http://example.org/tags/blog/">
                blog
            </a>
        </span>
        
        
        
        <span class="tag">
            <a href="http://example.org/tags/ios/">
                iOS
            </a>
        </span>
        
        
        
        <span class="tag">
            <a href="http://example.org/tags/clang/">
                Clang
            </a>
        </span>
        
        
    </div>
    <hr/>
    <h1 id="clang">Clang</h1>
<p>作为一个iOS工程师，每次看到Xcode在进行漫长的编译的时候总是忍不住想深究一下自己手写的BUG是如何被生成的，所以下定决定研究一下我们的编译器</p>
<p>要探究首先要知道我们使用的是LLVM编译器</p>
<h2 id="llvmlow-level-virtual-machine">LLVM（Low Level Virtual Machine）</h2>
<blockquote>
<p>LLVM是一个自由软件项目，它是一种编译器基础设施，以C++写成，包含一系列模块化的编译器组件和工具链，用来开发编译器前端和后端。它是为了任意一种编程语言而写成的程序，利用虚拟技术创造出编译时期、链接时期、运行时期以及“闲置时期”的最优化。它最早以C/C++为实现对象，而当前它已支持包括ActionScript、Ada、D语言、Fortran、GLSL、Haskell、Java字节码、Objective-C、Swift、Python、Ruby、Rust、Scala以及C#等语言。</p>
</blockquote>
<p>以上摘自维基百科</p>
<h2 id="几种编译器简介">几种编译器简介</h2>
<p>目前市面上常见的编译器有以下两种</p>
<ul>
<li>GCC（GNU Compiler Collection）</li>
<li>LLVM</li>
</ul>
<p>LLVM 我们上面已经稍微介绍过了，下面引用维基百科对GCC的定义</p>
<blockquote>
<p>GNU编译器套装（英语：GNU Compiler Collection，缩写为GCC），指一套编程语言编译器，以GPL及LGPL许可证所发行的自由软件，也是GNU项目的关键部分，也是GNU工具链的主要组成部分之一。GCC（特别是其中的C语言编译器）也常被认为是跨平台编译器的事实标准。1985年由理查德·马修·斯托曼开始发展，现在由自由软件基金会负责维护工作。
原名为GNU C语言编译器（GNU C Compiler），因为它原本只能处理C语言。GCC在发布后很快地得到扩展，变得可处理C++。之后也变得可处理Fortran、Pascal、Objective-C、Java、Ada，Go与其他语言。
许多操作系统，包括许多类Unix系统，如Linux及BSD家族都采用GCC作为标准编译器。</p>
</blockquote>
<h3 id="llvm与gcc">LLVM与GCC</h3>
<p>我们现在所使用的Xcode采用的是LLVM，以前曾经使用过GCC，见下表</p>
<table>
<thead>
<tr>
<th>Xcode 版本</th>
<th>应用编译器</th>
</tr>
</thead>
<tbody>
<tr>
<td>&lt; Xcode3</td>
<td>GCC</td>
</tr>
<tr>
<td>Xcode3</td>
<td>GCC + LLVM</td>
</tr>
<tr>
<td>Xcode4.2</td>
<td>默认LLVM-Clang</td>
</tr>
<tr>
<td>&gt; Xcode5</td>
<td>废弃GCC</td>
</tr>
</tbody>
</table>
<p>那么，同样是编译器，为何Xcode最终选择LLVM而舍弃Clang呢</p>
<ul>
<li>Apple对Objective-C新增的特性，GCC并未配合给予实现</li>
<li>GCC编译器前后端代码耦合度过高</li>
<li>license GCC限制了LLVM-GCC的开发</li>
</ul>
<h2 id="llvm-设计思想">LLVM 设计思想</h2>
<p>以下是传统的三相设计思想</p>
<ul>
<li>前端</li>
<li>优化器</li>
<li>后端</li>
</ul>
<p>对于iOS开发者来说，整个流程可以简要概括为 Clang对代码进行处理形成中间层作为输出，llvm把CLang的输出作为输入生成机器码</p>
<h3 id="frontend">Frontend</h3>
<p>下面就到了这篇文章的重点了，LLVM编译器的前端，Clang</p>
<h3 id="clang-1">Clang</h3>
<blockquote>
<p>这个软件项目在2005年由苹果计算机发起，是LLVM编译器工具集的前端（front-end），目的是输出代码对应的抽象语法树（Abstract Syntax Tree, AST），并将代码编译成LLVM Bitcode。接着在后端（back-end）使用LLVM编译成平台相关的机器语言 。Clang支持C、C++、Objective C。
在Clang语言中，使用Stmt来代表statement。Clang代码的单元（unit）皆为语句（statement），语法树的节点（node）类型就是Stmt。另外Clang的表达式（Expression）也是语句的一种，Clang使用Expr来代表Expression，Expr本身继承自Stmt。节点之下有子节点列表（sub-node-list）。
Clang本身性能优异，其生成的AST所耗用掉的内存仅仅是GCC的20%左右。FreeBSD操作系统自2014年1月发行的10.0版本开始将Clang/LLVM作为默认编译器[3]。</p>
</blockquote>
<p>Clang的执行过程包含以下几步</p>
<ol>
<li>宏替换，头文件导入</li>
<li>语法分析，代码切割为token</li>
<li>组成AST（抽象语法树）</li>
<li>生成中间码（IR）</li>
</ol>
<p>下面我们创建一个CommandLine工程来试验一下，demo托管在Github</p>
<p>首先打开Xcode创建工程，语言选择objective-c接下来我们找到 main.m ,</p>
<h4 id="首先查看编译步骤">首先查看编译步骤</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">clang -ccc-print-phases ClangTest/main.m
</code></pre></div><p>可以看到输出</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">0: input, <span style="color:#e6db74">&#34;ClangTest/main.m&#34;</span>, objective-c
1: preprocessor, <span style="color:#f92672">{</span>0<span style="color:#f92672">}</span>, objective-c-cpp-output
2: compiler, <span style="color:#f92672">{</span>1<span style="color:#f92672">}</span>, ir
3: backend, <span style="color:#f92672">{</span>2<span style="color:#f92672">}</span>, assembler
4: assembler, <span style="color:#f92672">{</span>3<span style="color:#f92672">}</span>, object
5: linker, <span style="color:#f92672">{</span>4<span style="color:#f92672">}</span>, image
6: bind-arch, <span style="color:#e6db74">&#34;x86_64&#34;</span>, <span style="color:#f92672">{</span>5<span style="color:#f92672">}</span>, image
</code></pre></div><h4 id="查看预处理结果">查看预处理结果</h4>
<p>也就是宏替换和头文件导入步骤</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">clang -E ClangTest/main.m
</code></pre></div><p>我们可以看到输出如下（前面部分省略）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objc" data-lang="objc"><span style="color:#75715e"># 1 &#34;/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.14.sdk/System/Library/Frameworks/Foundation.framework/Headers/FoundationLegacySwiftCompatibility.h&#34; 1 3
</span><span style="color:#75715e"># 185 &#34;/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.14.sdk/System/Library/Frameworks/Foundation.framework/Headers/Foundation.h&#34; 2 3
</span><span style="color:#75715e"># 10 &#34;ClangTest/main.m&#34; 2
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> argv[]) {
    <span style="color:#66d9ef">@autoreleasepool</span> {

        NSLog(<span style="color:#e6db74">@&#34;Hello, World!&#34;</span>);
    }
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><h4 id="代码切割token">代码切割token</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">clang -fmodules -fsyntax-only -Xclang -dump-tokens ClangTest/main.m
</code></pre></div><p>输出如下</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">annot_module_include <span style="color:#e6db74">&#39;#import &lt;Foundation/Foundation.h&gt;
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">int main(int argc, const char * argv[]) {
</span><span style="color:#e6db74">    @autoreleasepool {
</span><span style="color:#e6db74">        // insert code here...&#39;</span>         Loc<span style="color:#f92672">=</span>&lt;ClangTest/main.m:9:1&gt;
int <span style="color:#e6db74">&#39;int&#39;</span>        <span style="color:#f92672">[</span>StartOfLine<span style="color:#f92672">]</span>  Loc<span style="color:#f92672">=</span>&lt;ClangTest/main.m:11:1&gt;
identifier <span style="color:#e6db74">&#39;main&#39;</span>        <span style="color:#f92672">[</span>LeadingSpace<span style="color:#f92672">]</span> Loc<span style="color:#f92672">=</span>&lt;ClangTest/main.m:11:5&gt;
l_paren <span style="color:#e6db74">&#39;(&#39;</span>             Loc<span style="color:#f92672">=</span>&lt;ClangTest/main.m:11:9&gt;
int <span style="color:#e6db74">&#39;int&#39;</span>               Loc<span style="color:#f92672">=</span>&lt;ClangTest/main.m:11:10&gt;
identifier <span style="color:#e6db74">&#39;argc&#39;</span>        <span style="color:#f92672">[</span>LeadingSpace<span style="color:#f92672">]</span> Loc<span style="color:#f92672">=</span>&lt;ClangTest/main.m:11:14&gt;
comma <span style="color:#e6db74">&#39;,&#39;</span>               Loc<span style="color:#f92672">=</span>&lt;ClangTest/main.m:11:18&gt;
const <span style="color:#e6db74">&#39;const&#39;</span>    <span style="color:#f92672">[</span>LeadingSpace<span style="color:#f92672">]</span> Loc<span style="color:#f92672">=</span>&lt;ClangTest/main.m:11:20&gt;
char <span style="color:#e6db74">&#39;char&#39;</span>      <span style="color:#f92672">[</span>LeadingSpace<span style="color:#f92672">]</span> Loc<span style="color:#f92672">=</span>&lt;ClangTest/main.m:11:26&gt;
star <span style="color:#e6db74">&#39;*&#39;</span>         <span style="color:#f92672">[</span>LeadingSpace<span style="color:#f92672">]</span> Loc<span style="color:#f92672">=</span>&lt;ClangTest/main.m:11:31&gt;
identifier <span style="color:#e6db74">&#39;argv&#39;</span>        <span style="color:#f92672">[</span>LeadingSpace<span style="color:#f92672">]</span> Loc<span style="color:#f92672">=</span>&lt;ClangTest/main.m:11:33&gt;
l_square <span style="color:#e6db74">&#39;[&#39;</span>            Loc<span style="color:#f92672">=</span>&lt;ClangTest/main.m:11:37&gt;
r_square <span style="color:#e6db74">&#39;]&#39;</span>            Loc<span style="color:#f92672">=</span>&lt;ClangTest/main.m:11:38&gt;
r_paren <span style="color:#e6db74">&#39;)&#39;</span>             Loc<span style="color:#f92672">=</span>&lt;ClangTest/main.m:11:39&gt;
l_brace <span style="color:#e6db74">&#39;{&#39;</span>      <span style="color:#f92672">[</span>LeadingSpace<span style="color:#f92672">]</span> Loc<span style="color:#f92672">=</span>&lt;ClangTest/main.m:11:41&gt;
at <span style="color:#e6db74">&#39;@&#39;</span>   <span style="color:#f92672">[</span>StartOfLine<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>LeadingSpace<span style="color:#f92672">]</span>   Loc<span style="color:#f92672">=</span>&lt;ClangTest/main.m:12:5&gt;
identifier <span style="color:#e6db74">&#39;autoreleasepool&#39;</span>            Loc<span style="color:#f92672">=</span>&lt;ClangTest/main.m:12:6&gt;
l_brace <span style="color:#e6db74">&#39;{&#39;</span>      <span style="color:#f92672">[</span>LeadingSpace<span style="color:#f92672">]</span> Loc<span style="color:#f92672">=</span>&lt;ClangTest/main.m:12:22&gt;
identifier <span style="color:#e6db74">&#39;NSLog&#39;</span>       <span style="color:#f92672">[</span>StartOfLine<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>LeadingSpace<span style="color:#f92672">]</span>   Loc<span style="color:#f92672">=</span>&lt;ClangTest/main.m:14:9&gt;
l_paren <span style="color:#e6db74">&#39;(&#39;</span>             Loc<span style="color:#f92672">=</span>&lt;ClangTest/main.m:14:14&gt;
at <span style="color:#e6db74">&#39;@&#39;</span>          Loc<span style="color:#f92672">=</span>&lt;ClangTest/main.m:14:15&gt;
string_literal <span style="color:#e6db74">&#39;&#34;Hello, World!&#34;&#39;</span>                Loc<span style="color:#f92672">=</span>&lt;ClangTest/main.m:14:16&gt;
r_paren <span style="color:#e6db74">&#39;)&#39;</span>             Loc<span style="color:#f92672">=</span>&lt;ClangTest/main.m:14:31&gt;
semi <span style="color:#e6db74">&#39;;&#39;</span>                Loc<span style="color:#f92672">=</span>&lt;ClangTest/main.m:14:32&gt;
r_brace <span style="color:#e6db74">&#39;}&#39;</span>      <span style="color:#f92672">[</span>StartOfLine<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>LeadingSpace<span style="color:#f92672">]</span>   Loc<span style="color:#f92672">=</span>&lt;ClangTest/main.m:15:5&gt;
<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;return&#39;</span>  <span style="color:#f92672">[</span>StartOfLine<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>LeadingSpace<span style="color:#f92672">]</span>   Loc<span style="color:#f92672">=</span>&lt;ClangTest/main.m:16:5&gt;
numeric_constant <span style="color:#e6db74">&#39;0&#39;</span>     <span style="color:#f92672">[</span>LeadingSpace<span style="color:#f92672">]</span> Loc<span style="color:#f92672">=</span>&lt;ClangTest/main.m:16:12&gt;
semi <span style="color:#e6db74">&#39;;&#39;</span>                Loc<span style="color:#f92672">=</span>&lt;ClangTest/main.m:16:13&gt;
r_brace <span style="color:#e6db74">&#39;}&#39;</span>      <span style="color:#f92672">[</span>StartOfLine<span style="color:#f92672">]</span>  Loc<span style="color:#f92672">=</span>&lt;ClangTest/main.m:17:1&gt;
eof <span style="color:#e6db74">&#39;&#39;</span>          Loc<span style="color:#f92672">=</span>&lt;ClangTest/main.m:17:2&gt;
</code></pre></div><p>可以看到，括号，符号，关键字等等都被切割出来了</p>
<h4 id="语法分析组成ast抽象语法树">语法分析，组成AST（抽象语法树）</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">clang -fmodules -fsyntax-only -Xclang -ast-dump ClangTest/main.m
</code></pre></div><p>可以看到AST输出如下:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">TranslationUnitDecl 0x7f95b28032e8 <span style="color:#e6db74">&lt;&lt;invalid sloc&gt;&gt; &lt;invalid</span> sloc&gt;
|-TypedefDecl 0x7f95b2803b80 <span style="color:#e6db74">&lt;&lt;invalid sloc&gt;&gt; &lt;invalid</span> sloc&gt; implicit __int128_t <span style="color:#e6db74">&#39;__int128&#39;</span>
| <span style="color:#e6db74">`</span>-BuiltinType 0x7f95b2803880 <span style="color:#e6db74">&#39;__int128&#39;</span>
|-TypedefDecl 0x7f95b2803be8 <span style="color:#e6db74">&lt;&lt;invalid sloc&gt;&gt; &lt;invalid</span> sloc&gt; implicit __uint128_t <span style="color:#e6db74">&#39;unsigned __int128&#39;</span>
| <span style="color:#e6db74">`</span>-BuiltinType 0x7f95b28038a0 <span style="color:#e6db74">&#39;unsigned __int128&#39;</span>
|-TypedefDecl 0x7f95b2803c80 <span style="color:#e6db74">&lt;&lt;invalid sloc&gt;&gt; &lt;invalid</span> sloc&gt; implicit SEL <span style="color:#e6db74">&#39;SEL *&#39;</span>
| <span style="color:#e6db74">`</span>-PointerType 0x7f95b2803c40 <span style="color:#e6db74">&#39;SEL *&#39;</span> imported
|   <span style="color:#e6db74">`</span>-BuiltinType 0x7f95b2803ae0 <span style="color:#e6db74">&#39;SEL&#39;</span>
|-TypedefDecl 0x7f95b2803d58 <span style="color:#e6db74">&lt;&lt;invalid sloc&gt;&gt; &lt;invalid</span> sloc&gt; implicit id <span style="color:#e6db74">&#39;id&#39;</span>
| <span style="color:#e6db74">`</span>-ObjCObjectPointerType 0x7f95b2803d00 <span style="color:#e6db74">&#39;id&#39;</span> imported
|   <span style="color:#e6db74">`</span>-ObjCObjectType 0x7f95b2803cd0 <span style="color:#e6db74">&#39;id&#39;</span> imported
|-TypedefDecl 0x7f95b2803e38 <span style="color:#e6db74">&lt;&lt;invalid sloc&gt;&gt; &lt;invalid</span> sloc&gt; implicit Class <span style="color:#e6db74">&#39;Class&#39;</span>
| <span style="color:#e6db74">`</span>-ObjCObjectPointerType 0x7f95b2803de0 <span style="color:#e6db74">&#39;Class&#39;</span> imported
|   <span style="color:#e6db74">`</span>-ObjCObjectType 0x7f95b2803db0 <span style="color:#e6db74">&#39;Class&#39;</span> imported
|-ObjCInterfaceDecl 0x7f95b2803e88 <span style="color:#e6db74">&lt;&lt;invalid sloc&gt;&gt; &lt;invalid</span> sloc&gt; implicit Protocol
|-TypedefDecl 0x7f95b28465e8 <span style="color:#e6db74">&lt;&lt;invalid sloc&gt;&gt; &lt;invalid</span> sloc&gt; implicit __NSConstantString <span style="color:#e6db74">&#39;struct __NSConstantString_tag&#39;</span>
| <span style="color:#e6db74">`</span>-RecordType 0x7f95b2846400 <span style="color:#e6db74">&#39;struct __NSConstantString_tag&#39;</span>
|   <span style="color:#e6db74">`</span>-Record 0x7f95b2803f50 <span style="color:#e6db74">&#39;__NSConstantString_tag&#39;</span>
|-TypedefDecl 0x7f95b2846680 <span style="color:#e6db74">&lt;&lt;invalid sloc&gt;&gt; &lt;invalid</span> sloc&gt; implicit __builtin_ms_va_list <span style="color:#e6db74">&#39;char *&#39;</span>
| <span style="color:#e6db74">`</span>-PointerType 0x7f95b2846640 <span style="color:#e6db74">&#39;char *&#39;</span>
|   <span style="color:#e6db74">`</span>-BuiltinType 0x7f95b2803380 <span style="color:#e6db74">&#39;char&#39;</span>
|-TypedefDecl 0x7f95b2846948 <span style="color:#e6db74">&lt;&lt;invalid sloc&gt;&gt; &lt;invalid</span> sloc&gt; implicit __builtin_va_list <span style="color:#e6db74">&#39;struct __va_list_tag [1]&#39;</span>
| <span style="color:#e6db74">`</span>-ConstantArrayType 0x7f95b28468f0 <span style="color:#e6db74">&#39;struct __va_list_tag [1]&#39;</span> <span style="color:#ae81ff">1</span>
|   <span style="color:#e6db74">`</span>-RecordType 0x7f95b2846770 <span style="color:#e6db74">&#39;struct __va_list_tag&#39;</span>
|     <span style="color:#e6db74">`</span>-Record 0x7f95b28466d0 <span style="color:#e6db74">&#39;__va_list_tag&#39;</span>
|-ImportDecl 0x7f95b30612f8 &lt;ClangTest/main.m:9:1&gt; col:1 implicit Foundation
|-FunctionDecl 0x7f95b30615a8 &lt;line:11:1, line:17:1&gt; line:11:5 main <span style="color:#e6db74">&#39;int (int, const char **)&#39;</span>
| |-ParmVarDecl 0x7f95b3061348 &lt;col:10, col:14&gt; col:14 argc <span style="color:#e6db74">&#39;int&#39;</span>
| |-ParmVarDecl 0x7f95b3061460 &lt;col:20, col:38&gt; col:33 argv <span style="color:#e6db74">&#39;const char **&#39;</span>:<span style="color:#e6db74">&#39;const char **&#39;</span>
| <span style="color:#e6db74">`</span>-CompoundStmt 0x7f95b2260ae8 &lt;col:41, line:17:1&gt;
|   |-ObjCAutoreleasePoolStmt 0x7f95b2260aa0 &lt;line:12:5, line:15:5&gt;
|   | <span style="color:#e6db74">`</span>-CompoundStmt 0x7f95b2260a88 &lt;line:12:22, line:15:5&gt;
|   |   <span style="color:#e6db74">`</span>-CallExpr 0x7f95b2260a40 &lt;line:14:9, col:31&gt; <span style="color:#e6db74">&#39;void&#39;</span>
|   |     |-ImplicitCastExpr 0x7f95b2260a28 &lt;col:9&gt; <span style="color:#e6db74">&#39;void (*)(id, ...)&#39;</span> &lt;FunctionToPointerDecay&gt;
|   |     | <span style="color:#e6db74">`</span>-DeclRefExpr 0x7f95b2260910 &lt;col:9&gt; <span style="color:#e6db74">&#39;void (id, ...)&#39;</span> Function 0x7f95b30616e8 <span style="color:#e6db74">&#39;NSLog&#39;</span> <span style="color:#e6db74">&#39;void (id, ...)&#39;</span>
|   |     <span style="color:#e6db74">`</span>-ImplicitCastExpr 0x7f95b2260a70 &lt;col:15, col:16&gt; <span style="color:#e6db74">&#39;id&#39;</span>:<span style="color:#e6db74">&#39;id&#39;</span> &lt;BitCast&gt;
|   |       <span style="color:#e6db74">`</span>-ObjCStringLiteral 0x7f95b22609b0 &lt;col:15, col:16&gt; <span style="color:#e6db74">&#39;NSString *&#39;</span>
|   |         <span style="color:#e6db74">`</span>-StringLiteral 0x7f95b2260978 &lt;col:16&gt; <span style="color:#e6db74">&#39;char [14]&#39;</span> lvalue <span style="color:#e6db74">&#34;Hello, World!&#34;</span>
|   <span style="color:#e6db74">`</span>-ReturnStmt 0x7f95b2260ad0 &lt;line:16:5, col:12&gt;
|     <span style="color:#e6db74">`</span>-IntegerLiteral 0x7f95b2260ab0 &lt;col:12&gt; <span style="color:#e6db74">&#39;int&#39;</span> <span style="color:#ae81ff">0</span>
<span style="color:#e6db74">`</span>-&lt;undeserialized declarations&gt;
</code></pre></div><h4 id="生成irintermediate-representation">生成IR(intermediate representation)</h4>
<p>这一步CodeGen会自顶向下遍历AST，产出中间层，也就是IR</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">clang -S -fobjc-arc -emit-llvm ClangTest/main.m -o main.ll
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">; ModuleID <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;ClangTest/main.m&#39;</span>
source_filename <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ClangTest/main.m&#34;</span>
target datalayout <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;e-m:o-i64:64-f80:128-n8:16:32:64-S128&#34;</span>
target triple <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;x86_64-apple-macosx10.14.0&#34;</span>

%struct.__NSConstantString_tag <span style="color:#f92672">=</span> type <span style="color:#f92672">{</span> i32*, i32, i8*, i64 <span style="color:#f92672">}</span>

@__CFConstantStringClassReference <span style="color:#f92672">=</span> external global <span style="color:#f92672">[</span><span style="color:#ae81ff">0</span> x i32<span style="color:#f92672">]</span>
@.str <span style="color:#f92672">=</span> private unnamed_addr constant <span style="color:#f92672">[</span><span style="color:#ae81ff">14</span> x i8<span style="color:#f92672">]</span> c<span style="color:#e6db74">&#34;Hello, World!\00&#34;</span>, section <span style="color:#e6db74">&#34;__TEXT,__cstring,cstring_literals&#34;</span>, align <span style="color:#ae81ff">1</span>
@_unnamed_cfstring_ <span style="color:#f92672">=</span> private global %struct.__NSConstantString_tag <span style="color:#f92672">{</span> i32* getelementptr inbounds <span style="color:#f92672">([</span><span style="color:#ae81ff">0</span> x i32<span style="color:#f92672">]</span>, <span style="color:#f92672">[</span><span style="color:#ae81ff">0</span> x i32<span style="color:#f92672">]</span>* @__CFConstantStringClassReference, i32 0, i32 0<span style="color:#f92672">)</span>, i32 1992, i8* getelementptr inbounds <span style="color:#f92672">([</span><span style="color:#ae81ff">14</span> x i8<span style="color:#f92672">]</span>, <span style="color:#f92672">[</span><span style="color:#ae81ff">14</span> x i8<span style="color:#f92672">]</span>* @.str, i32 0, i32 0<span style="color:#f92672">)</span>, i64 <span style="color:#ae81ff">13</span> <span style="color:#f92672">}</span>, section <span style="color:#e6db74">&#34;__DATA,__cfstring&#34;</span>, align <span style="color:#ae81ff">8</span>

; Function Attrs: noinline optnone ssp uwtable
define i32 @main<span style="color:#f92672">(</span>i32, i8**<span style="color:#f92672">)</span> <span style="color:#75715e">#0 {</span>
  %3 <span style="color:#f92672">=</span> alloca i32, align <span style="color:#ae81ff">4</span>
  %4 <span style="color:#f92672">=</span> alloca i32, align <span style="color:#ae81ff">4</span>
  %5 <span style="color:#f92672">=</span> alloca i8**, align <span style="color:#ae81ff">8</span>
  store i32 0, i32* %3, align <span style="color:#ae81ff">4</span>
  store i32 %0, i32* %4, align <span style="color:#ae81ff">4</span>
  store i8** %1, i8*** %5, align <span style="color:#ae81ff">8</span>
  %6 <span style="color:#f92672">=</span> call i8* @objc_autoreleasePoolPush<span style="color:#f92672">()</span> <span style="color:#75715e">#2</span>
  notail call void <span style="color:#f92672">(</span>i8*, ...<span style="color:#f92672">)</span> @NSLog<span style="color:#f92672">(</span>i8* bitcast <span style="color:#f92672">(</span>%struct.__NSConstantString_tag* @_unnamed_cfstring_ to i8*<span style="color:#f92672">))</span>
  call void @objc_autoreleasePoolPop<span style="color:#f92672">(</span>i8* %6<span style="color:#f92672">)</span>
  ret i32 <span style="color:#ae81ff">0</span>
<span style="color:#f92672">}</span>

declare i8* @objc_autoreleasePoolPush<span style="color:#f92672">()</span>

declare void @NSLog<span style="color:#f92672">(</span>i8*, ...<span style="color:#f92672">)</span> <span style="color:#75715e">#1</span>

declare void @objc_autoreleasePoolPop<span style="color:#f92672">(</span>i8*<span style="color:#f92672">)</span>

attributes <span style="color:#75715e">#0 = { noinline optnone ssp uwtable &#34;correctly-rounded-divide-sqrt-fp-math&#34;=&#34;false&#34; &#34;disable-tail-calls&#34;=&#34;false&#34; &#34;less-precise-fpmad&#34;=&#34;false&#34; &#34;no-frame-pointer-elim&#34;=&#34;true&#34; &#34;no-frame-pointer-elim-non-leaf&#34; &#34;no-infs-fp-math&#34;=&#34;false&#34; &#34;no-jump-tables&#34;=&#34;false&#34; &#34;no-nans-fp-math&#34;=&#34;false&#34; &#34;no-signed-zeros-fp-math&#34;=&#34;false&#34; &#34;no-trapping-math&#34;=&#34;false&#34; &#34;stack-protector-buffer-size&#34;=&#34;8&#34; &#34;target-cpu&#34;=&#34;penryn&#34; &#34;target-features&#34;=&#34;+cx16,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87&#34; &#34;unsafe-fp-math&#34;=&#34;false&#34; &#34;use-soft-float&#34;=&#34;false&#34; }</span>
attributes <span style="color:#75715e">#1 = { &#34;correctly-rounded-divide-sqrt-fp-math&#34;=&#34;false&#34; &#34;disable-tail-calls&#34;=&#34;false&#34; &#34;less-precise-fpmad&#34;=&#34;false&#34; &#34;no-frame-pointer-elim&#34;=&#34;true&#34; &#34;no-frame-pointer-elim-non-leaf&#34; &#34;no-infs-fp-math&#34;=&#34;false&#34; &#34;no-nans-fp-math&#34;=&#34;false&#34; &#34;no-signed-zeros-fp-math&#34;=&#34;false&#34; &#34;no-trapping-math&#34;=&#34;false&#34; &#34;stack-protector-buffer-size&#34;=&#34;8&#34; &#34;target-cpu&#34;=&#34;penryn&#34; &#34;target-features&#34;=&#34;+cx16,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87&#34; &#34;unsafe-fp-math&#34;=&#34;false&#34; &#34;use-soft-float&#34;=&#34;false&#34; }</span>
attributes <span style="color:#75715e">#2 = { nounwind }</span>

!llvm.module.flags <span style="color:#f92672">=</span> !<span style="color:#f92672">{</span>!0, !1, !2, !3, !4, !5, !6, !7<span style="color:#f92672">}</span>
!llvm.ident <span style="color:#f92672">=</span> !<span style="color:#f92672">{</span>!8<span style="color:#f92672">}</span>

!0 <span style="color:#f92672">=</span> !<span style="color:#f92672">{</span>i32 2, !<span style="color:#e6db74">&#34;SDK Version&#34;</span>, <span style="color:#f92672">[</span><span style="color:#ae81ff">2</span> x i32<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>i32 10, i32 14<span style="color:#f92672">]}</span>
!1 <span style="color:#f92672">=</span> !<span style="color:#f92672">{</span>i32 1, !<span style="color:#e6db74">&#34;Objective-C Version&#34;</span>, i32 2<span style="color:#f92672">}</span>
!2 <span style="color:#f92672">=</span> !<span style="color:#f92672">{</span>i32 1, !<span style="color:#e6db74">&#34;Objective-C Image Info Version&#34;</span>, i32 0<span style="color:#f92672">}</span>
!3 <span style="color:#f92672">=</span> !<span style="color:#f92672">{</span>i32 1, !<span style="color:#e6db74">&#34;Objective-C Image Info Section&#34;</span>, !<span style="color:#e6db74">&#34;__DATA,__objc_imageinfo,regular,no_dead_strip&#34;</span><span style="color:#f92672">}</span>
!4 <span style="color:#f92672">=</span> !<span style="color:#f92672">{</span>i32 4, !<span style="color:#e6db74">&#34;Objective-C Garbage Collection&#34;</span>, i32 0<span style="color:#f92672">}</span>
!5 <span style="color:#f92672">=</span> !<span style="color:#f92672">{</span>i32 1, !<span style="color:#e6db74">&#34;Objective-C Class Properties&#34;</span>, i32 64<span style="color:#f92672">}</span>
!6 <span style="color:#f92672">=</span> !<span style="color:#f92672">{</span>i32 1, !<span style="color:#e6db74">&#34;wchar_size&#34;</span>, i32 4<span style="color:#f92672">}</span>
!7 <span style="color:#f92672">=</span> !<span style="color:#f92672">{</span>i32 7, !<span style="color:#e6db74">&#34;PIC Level&#34;</span>, i32 2<span style="color:#f92672">}</span>
!8 <span style="color:#f92672">=</span> !<span style="color:#f92672">{</span>!<span style="color:#e6db74">&#34;Apple LLVM version 10.0.1 (clang-1001.0.46.4)&#34;</span><span style="color:#f92672">}</span>
</code></pre></div><h4 id="查看生成的汇编代码">查看生成的汇编代码</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">clang -S -fobjc-arc ClangTest/main.m -o main.s
</code></pre></div><p>如下：</p>
<pre><code class="language-assembly" data-lang="assembly">        .section        __TEXT,__text,regular,pure_instructions
        .build_version macos, 10, 14    sdk_version 10, 14
        .globl  _main                   ## -- Begin function main
        .p2align        4, 0x90
_main:                                  ## @main
        .cfi_startproc
## %bb.0:
        pushq   %rbp
        .cfi_def_cfa_offset 16
        .cfi_offset %rbp, -16
        movq    %rsp, %rbp
        .cfi_def_cfa_register %rbp
        subq    $32, %rsp
        movl    $0, -4(%rbp)
        movl    %edi, -8(%rbp)
        movq    %rsi, -16(%rbp)
        callq   _objc_autoreleasePoolPush
        leaq    L__unnamed_cfstring_(%rip), %rsi
        movq    %rsi, %rdi
        movq    %rax, -24(%rbp)         ## 8-byte Spill
        movb    $0, %al
        callq   _NSLog
        movq    -24(%rbp), %rdi         ## 8-byte Reload
        callq   _objc_autoreleasePoolPop
        xorl    %eax, %eax
        addq    $32, %rsp
        popq    %rbp
        retq
        .cfi_endproc
                                        ## -- End function
        .section        __TEXT,__cstring,cstring_literals
L_.str:                                 ## @.str
        .asciz  &quot;Hello, World!&quot;

        .section        __DATA,__cfstring
        .p2align        3               ## @_unnamed_cfstring_
L__unnamed_cfstring_:
        .quad   ___CFConstantStringClassReference
        .long   1992                    ## 0x7c8
        .space  4
        .quad   L_.str
        .quad   13                      ## 0xd

        .section        __DATA,__objc_imageinfo,regular,no_dead_strip
L_OBJC_IMAGE_INFO:
        .long   0
        .long   64


.subsections_via_symbols
</code></pre><h4 id="生成目标文件">生成目标文件</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">clang -fmodules -c ClangTest/main.m -o main.o  
</code></pre></div><h4 id="生成可执行文件">生成可执行文件</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">clang main.o -o main
</code></pre></div><p>运行</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">./main
</code></pre></div><p>以这个例子来说，虽然我们一行代码都没有写，但是看得出来，编译器为我们做的事情可不少，接下来我想在编译器中添加一个插件，打印工程中所有的方法名</p>
<h2 id="clang-2">Clang</h2>
<p>说了这么多</p>
<p>下面我们从官网下载并编译最新的Clang</p>
<h2 id="编译源码">编译源码</h2>
<ol>
<li>下载源码 git clone <a href="https://github.com/llvm/llvm-project.git">https://github.com/llvm/llvm-project.git</a></li>
<li>创建build目录 cd llvm-project &amp;&amp; mkdir build &amp;&amp; cd build</li>
<li>编译源码 cmake -DLLVM_ENABLE_PROJECTS=clang -G &ldquo;Unix Makefiles&rdquo; ../llvm</li>
<li>cmake -build .</li>
<li>make clang</li>
</ol>
<h3 id="测试是否成功">测试是否成功</h3>
<p>输入</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">./bin/clang-9 --version
</code></pre></div><p>正常输出clang就没什么问题了</p>
<h2 id="替换xcode的clang">替换Xcode的Clang</h2>
<p>还是用刚才那个ClangTest工程，这里我们要替换掉Xcode使用的Clang为我们自己编译的版本</p>
<p>点击工程，找到Build Settings，点击加号，选择 Add User-Defined settings</p>
<p>添加如下两条</p>
<ul>
<li>CC /Users/felix/Documents/llvm-project/build/bin/clang-9</li>
<li>CXX /Users/felix/Documents/llvm-project/build/bin/clang-9</li>
</ul>
<p>将路径替换为你编译文件的路径</p>
<p>然后搜索Enable Index-While-Building Functionality ,将值更改为No</p>
<p>接下来可以Command+B进行编译</p>
<h2 id="clang-plugin">Clang Plugin</h2>
<p>下面来开发我们的第一个插件，打印所有的方法名</p>
<h3 id="编写第一个clang插件">编写第一个CLang插件</h3>
<p>首先，进入 llvm-project/clang/examples， 创建新文件夹，命名为Find</p>
<p>在Find下新建两个文件 DemoPlugin.cpp、CMakeLists.txt</p>
<p>打开 llvm-project/clang/examples/CMakeLists.txt，在文件末尾追加</p>
<pre><code>add_subdirectory(DemoPlugin)
</code></pre><p>现在让我们编辑Find插件，</p>
<p>CMakeLists.txt</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#75715e"># If we don&#39;t need RTTI or EH, there&#39;s no reason to export anything
</span><span style="color:#75715e"># from the plugin.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span>( NOT MSVC ) <span style="color:#960050;background-color:#1e0010">#</span> MSVC mangles symbols differently, and
               <span style="color:#75715e"># PrintFunctionNames.export contains C++ symbols.
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>( NOT LLVM_REQUIRES_RTTI )
    <span style="color:#66d9ef">if</span>( NOT LLVM_REQUIRES_EH )
      set(LLVM_EXPORTED_SYMBOL_FILE <span style="color:#960050;background-color:#1e0010">$</span>{CMAKE_CURRENT_SOURCE_DIR}<span style="color:#f92672">/</span>DemoPlugin.exports)
    endif()
  endif()
endif()

add_llvm_library(DemoPlugin MODULE DemoPlugin.cpp PLUGIN_TOOL clang)

<span style="color:#66d9ef">if</span>(LLVM_ENABLE_PLUGINS AND (WIN32 OR CYGWIN))
	target_link_libraries(DemoPlugin PRIVATE
    clangAST
    clangBasic
    clangFrontend
    LLVMSupport
    )
endif()
</code></pre></div><p>DemoPlugin.cpp</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;clang/Frontend/FrontendPluginRegistry.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;clang/AST/AST.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;clang/AST/ASTConsumer.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;clang/AST/RecursiveASTVisitor.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;clang/Frontend/CompilerInstance.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">using</span> <span style="color:#66d9ef">namespace</span> clang;

<span style="color:#66d9ef">namespace</span>
{
    <span style="color:#75715e">// 可以深度优先搜索整个AST，并访问每一个基类，遍历需要处理的节点
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DemoPluginVisitor</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">public</span> RecursiveASTVisitor<span style="color:#f92672">&lt;</span>DemoPluginVisitor<span style="color:#f92672">&gt;</span>
    {
    <span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
        CompilerInstance <span style="color:#f92672">&amp;</span>Instance;
        ASTContext <span style="color:#f92672">*</span>Context;
        
    <span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
        <span style="color:#66d9ef">void</span> setASTContext (ASTContext <span style="color:#f92672">&amp;</span>context)
        {
            <span style="color:#66d9ef">this</span> <span style="color:#f92672">-&gt;</span> Context <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>context;
        }
        
        DemoPluginVisitor (CompilerInstance <span style="color:#f92672">&amp;</span>Instance)
        <span style="color:#f92672">:</span>Instance(Instance) {}
        
        <span style="color:#75715e">// 查找类名
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">VisitObjCInterfaceDecl</span>(ObjCInterfaceDecl <span style="color:#f92672">*</span>declaration) {
            <span style="color:#66d9ef">if</span>(isUserSourceCode(declaration)) {
                DiagnosticsEngine <span style="color:#f92672">&amp;</span>D <span style="color:#f92672">=</span> Instance.getDiagnostics();
                <span style="color:#66d9ef">unsigned</span> diagID <span style="color:#f92672">=</span> D.getCustomDiagID(DiagnosticsEngine<span style="color:#f92672">::</span>Warning, <span style="color:#e6db74">&#34;查找到一个类名: %0&#34;</span>);
                D.Report(declaration<span style="color:#f92672">-&gt;</span>getBeginLoc(), diagID) <span style="color:#f92672">&lt;&lt;</span> declaration<span style="color:#f92672">-&gt;</span>getName();
            }
            <span style="color:#66d9ef">return</span> true;
        }
        
        <span style="color:#75715e">// 查找方法名
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">VisitObjCMethodDecl</span>(ObjCMethodDecl <span style="color:#f92672">*</span>declaration) {
            <span style="color:#66d9ef">if</span>(isUserSourceCode(declaration)) {
                DiagnosticsEngine <span style="color:#f92672">&amp;</span>D <span style="color:#f92672">=</span> Instance.getDiagnostics();
                <span style="color:#66d9ef">unsigned</span> diagID <span style="color:#f92672">=</span> D.getCustomDiagID(DiagnosticsEngine<span style="color:#f92672">::</span>Warning, <span style="color:#e6db74">&#34;查找到一个方法名: %0&#34;</span>);
<span style="color:#75715e">//                D.Report(declaration-&gt;getLocStart(), diagID).AddString(declaration-&gt;getSelector().getAsString());
</span><span style="color:#75715e"></span>                 D.Report(declaration<span style="color:#f92672">-&gt;</span>getBeginLoc(), diagID) <span style="color:#f92672">&lt;&lt;</span> declaration<span style="color:#f92672">-&gt;</span>getSelector().getAsString();
            }
            <span style="color:#66d9ef">return</span> true;
        }
        
        <span style="color:#75715e">// 是否用户代码
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">isUserSourceCode</span> (Decl <span style="color:#f92672">*</span>decl){
            std<span style="color:#f92672">::</span>string filename <span style="color:#f92672">=</span> Instance.getSourceManager().getFilename(decl<span style="color:#f92672">-&gt;</span>getSourceRange().getBegin()).str();
            
            <span style="color:#66d9ef">if</span> (filename.empty())
                <span style="color:#66d9ef">return</span> false;
            <span style="color:#75715e">// 定义非Xcode中的源码都是用户源码
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span>(filename.find(<span style="color:#e6db74">&#34;/Applications/Xcode.app/&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
                <span style="color:#66d9ef">return</span> false;
            
            <span style="color:#66d9ef">return</span> true;
        }
    };
    
    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DemoPluginConsumer</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">public</span> ASTConsumer
    {
    <span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
        DemoPluginVisitor visitor;
        CompilerInstance <span style="color:#f92672">&amp;</span>Instance;
        std<span style="color:#f92672">::</span>set<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>string<span style="color:#f92672">&gt;</span> ParsedTemplates;
    <span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
        DemoPluginConsumer(CompilerInstance <span style="color:#f92672">&amp;</span>Instance,
                           std<span style="color:#f92672">::</span>set<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>string<span style="color:#f92672">&gt;</span> ParsedTemplates)
        <span style="color:#f92672">:</span> Instance(Instance), ParsedTemplates(ParsedTemplates), visitor(Instance) {}
        
        <span style="color:#75715e">// 每次分析到一个顶层定义时会回调此函数，返回true表示处理
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">HandleTopLevelDecl</span>(DeclGroupRef DG) <span style="color:#66d9ef">override</span>
        {
            <span style="color:#66d9ef">return</span> true;
        }
        
        <span style="color:#75715e">// ASTConsumer的入口函数
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">HandleTranslationUnit</span>(ASTContext<span style="color:#f92672">&amp;</span> context) <span style="color:#66d9ef">override</span>
        {
            visitor.setASTContext(context);
            visitor.TraverseDecl(context.getTranslationUnitDecl());
        }
    };
    
    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DemoPluginASTAction</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">public</span> PluginASTAction
    {
        std<span style="color:#f92672">::</span>set<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>string<span style="color:#f92672">&gt;</span> ParsedTemplates;
    <span style="color:#66d9ef">protected</span><span style="color:#f92672">:</span>
        std<span style="color:#f92672">::</span>unique_ptr<span style="color:#f92672">&lt;</span>ASTConsumer<span style="color:#f92672">&gt;</span> CreateASTConsumer(CompilerInstance <span style="color:#f92672">&amp;</span>CI,
                                                       llvm<span style="color:#f92672">::</span>StringRef) <span style="color:#66d9ef">override</span>
        {
            <span style="color:#66d9ef">return</span> llvm<span style="color:#f92672">::</span>make_unique<span style="color:#f92672">&lt;</span>DemoPluginConsumer<span style="color:#f92672">&gt;</span>(CI, ParsedTemplates);
        }
        <span style="color:#75715e">// 插件的入口函数
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">ParseArgs</span>(<span style="color:#66d9ef">const</span> CompilerInstance <span style="color:#f92672">&amp;</span>CI,
                       <span style="color:#66d9ef">const</span> std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>string<span style="color:#f92672">&gt;</span> <span style="color:#f92672">&amp;</span>args) <span style="color:#66d9ef">override</span> {
            <span style="color:#66d9ef">return</span> true;
        }
    };
}

<span style="color:#66d9ef">static</span> clang<span style="color:#f92672">::</span>FrontendPluginRegistry<span style="color:#f92672">::</span>Add<span style="color:#f92672">&lt;</span>DemoPluginASTAction<span style="color:#f92672">&gt;</span>
X(<span style="color:#e6db74">&#34;DemoPlugin&#34;</span>, <span style="color:#e6db74">&#34;demo plugin&#34;</span>);
</code></pre></div><h2 id="加载插件">加载插件</h2>
<p>首先，我们需要编译插件，</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">cmake -DLLVM_ENABLE_PROJECTS<span style="color:#f92672">=</span>clang -G <span style="color:#e6db74">&#34;Unix Makefiles&#34;</span> ../llvm
make DemoPlugin 
</code></pre></div><p>编译成功后我们可以在 build的lib 目录下找到 DemoPlugin.dylib</p>
<p>在工程中加入配置 Other C Flags ，加入以下配置</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">-Xclang -load -Xclang /Users/felix/Documents/llvm-project/build/lib/DemoPlugin.dylib -Xclang -add-plugin -Xclang DemoPlugin
</code></pre></div><h2 id="调试">调试</h2>
<p>下面我们就可以开始编译工程了，可以看到每个方法名和类名都被找到拉</p>
<p><img src="https://github.com/FelixScat/Pub/blob/master/image/clangTest.png?raw=true" alt="clangTest"></p>

</div>


        
<div class="section bottom-menu">
    
<hr />
<p>


    
        <a href="http://example.org/posts">back</a>
        
            &#183;
        
    

    
        
            <a href="http://example.org/posts">Posts</a>
        
    
    
        
            &#183; 
            <a href="http://example.org/tags/objc/">Arithmetic</a>
        
            &#183; 
            <a href="http://example.org/about">Who is Cb7d?</a>
        
    
    &#183; 
    <a href="http://example.org/">
        main
    </a>

</p>
</div>


        <div class="section footer">Cb7d &lsquo;s blog. <a href="mailto:cb7d23@gmail.com">cb7d23@gmail.com</a></div>
    </div>
</body>

</html>